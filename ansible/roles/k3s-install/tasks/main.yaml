- name: Install K3s
  shell: curl -sfL https://get.k3s.io | sh -
  args:
    creates: /usr/local/bin/k3s
  environment:
    INSTALL_K3S_EXEC: "server"

- name: Wait for K3s to be ready
  wait_for:
    path: /etc/rancher/k3s/k3s.yaml
    state: present
    timeout: 120

- name: Set kubeconfig permissions
  file:
    path: /etc/rancher/k3s/k3s.yaml
    mode: '0644'

- name: Verify K3s is running
  systemd:
    name: k3s
    state: started
    enabled: yes

- name: Create .kube directory for udemx user
  file:
    path: /opt/udemx/.kube
    state: directory
    owner: udemx
    group: udemx
    mode: '0755'

- name: Copy kubeconfig for udemx user
  copy:
    src: /etc/rancher/k3s/k3s.yaml
    dest: /opt/udemx/.kube/config
    owner: udemx
    group: udemx
    mode: '0600'
    remote_src: yes

- name: Set KUBECONFIG in udemx bashrc
  lineinfile:
    path: /opt/udemx/.bashrc
    line: 'export KUBECONFIG=/opt/udemx/.kube/config'
    create: yes