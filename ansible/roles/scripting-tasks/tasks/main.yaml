# Scripting tasks role - Deploy monitoring and backup scripts

- name: Create scripts directory
  file:
    path: /opt/scripts
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Create backups directory
  file:
    path: /opt/scripts/backups
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Create output directory
  file:
    path: /opt/scripts/output
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Create db-backup script
  copy:
    content: |
      #!/bin/bash

      DATE=$(date +%Y-%m-%d)
      BACKUP_DIR="/opt/scripts/backups/${DATE}"

      mkdir -p "${BACKUP_DIR}"

      MYSQL_POD=$(kubectl get pods -n udemx -l component=mysql -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)

      if [ -z "$MYSQL_POD" ]; then
          echo "ERROR: MySQL pod not found" >&2
          exit 1
      fi

      kubectl exec -n udemx ${MYSQL_POD} -- mysqldump -u root -pAlma1234 udemx_db > "${BACKUP_DIR}/backup.sql" 2>/dev/null

      gzip "${BACKUP_DIR}/backup.sql"
    dest: /opt/scripts/db-backup.sh
    mode: '0755'
    owner: root
    group: root

- name: Create last-three-mod script
  copy:
    content: |
      #!/bin/bash

      DATE=$(date +%Y-%m-%d)
      OUTPUT_FILE="/opt/scripts/output/last-three-mod-files-${DATE}.out"

      mkdir -p /opt/scripts/output

      ls -lt /var/log | grep "^-" | head -3 > "${OUTPUT_FILE}"
    dest: /opt/scripts/last-three-mod.sh
    mode: '0755'
    owner: root
    group: root

- name: Create last-five-day-mod-files script
  copy:
    content: |
      #!/bin/bash

      DATE=$(date +%Y-%m-%d)
      OUTPUT_FILE="/opt/scripts/output/last-five-day-mod-files-${DATE}.out"

      mkdir -p /opt/scripts/output

      find /var/log -type f -mtime -5 > "${OUTPUT_FILE}"
    dest: /opt/scripts/last-five-day-mod-files.sh
    mode: '0755'
    owner: root
    group: root

- name: Create loadavg script
  copy:
    content: |
      #!/bin/bash

      DATE=$(date +%Y-%m-%d)
      TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
      LOAD=$(cat /proc/loadavg | awk '{print $1, $2, $3}')

      echo "${TIMESTAMP} | Load: ${LOAD}" >> /var/log/loadavg-${DATE}.out
    dest: /opt/scripts/loadavg.sh
    mode: '0755'
    owner: root
    group: root

# Cron jobs

- name: Setup cron job for db-backup (daily at 2 AM)
  cron:
    name: "MySQL database backup"
    minute: "0"
    hour: "2"
    job: "/opt/scripts/db-backup.sh >> /var/log/db-backup.log 2>&1"
    user: root
    state: present

- name: Setup cron job for loadavg (every 15 minutes)
  cron:
    name: "System load average monitoring"
    minute: "*/15"
    job: "/opt/scripts/loadavg.sh"
    user: root
    state: present

# Run scripts once to generate initial output files
# Note: db-backup will nmot run here as MySQL pod may not exist yet
# It will run automatically via cron at 2 AM daily

- name: Run last-three-mod script to generate initial output
  shell: /opt/scripts/last-three-mod.sh
  changed_when: false

- name: Run last-five-day-mod-files script to generate initial output
  shell: /opt/scripts/last-five-day-mod-files.sh
  changed_when: false

- name: Run loadavg script to generate initial output
  shell: /opt/scripts/loadavg.sh
  changed_when: false

- name: Display scripts information
  debug:
    msg:
      - "=========================================="
      - "Monitoring scripts deployed successfully!"
      - "=========================================="
      - "Scripts location: /opt/scripts/"
      - ""
      - "Available scripts:"
      - "  - db-backup.sh (runs daily at 2 AM)"
      - "  - last-three-mod.sh"
      - "  - last-five-day-mod-files.sh"
      - "  - loadavg.sh (runs every 15 minutes)"
      - ""
      - "Output files:"
      - "  - Backups: /opt/scripts/backups/"
      - "  - Script outputs: /opt/scripts/output/"
      - "  - Load avg logs: /var/log/loadavg-*.out"
      - "=========================================="